# 决行藏聊天记录功能设置指南

## 功能概述

已为决行藏界面添加了聊天记录保存和管理功能,包括:

1. **自动保存聊天记录** - 每次对话自动保存到数据库
2. **查看历史对话** - 左侧侧边栏显示所有历史对话列表
3. **继续对话** - 点击任意历史对话即可继续聊天
4. **删除对话** - 支持删除不需要的对话记录
5. **自动生成标题** - 根据第一条消息自动生成对话标题

## 数据库设置

### 1. 执行数据库迁移

需要在 Supabase 数据库中执行以下 SQL 脚本来创建必要的表:

```bash
# SQL 脚本位置
src/app/api/chat-sessions/schema.sql
```

在 Supabase Dashboard 中:
1. 进入你的项目
2. 点击左侧菜单的 "SQL Editor"
3. 复制 `schema.sql` 文件的内容
4. 粘贴并执行

### 2. 表结构说明

创建了两个新表:

#### `chat_sessions` - 聊天会话表
- `id`: 会话唯一标识
- `user_id`: 用户ID (关联 auth.users)
- `title`: 会话标题
- `created_at`: 创建时间
- `updated_at`: 更新时间

#### `chat_messages` - 聊天消息表
- `id`: 消息唯一标识
- `session_id`: 所属会话ID
- `role`: 消息角色 (user/assistant)
- `content`: 消息内容
- `is_reasoning`: 是否为深思模式
- `created_at`: 创建时间

### 3. 权限设置

已配置 RLS (行级安全) 策略:
- 用户只能访问自己的会话和消息
- 自动关联到当前登录用户
- 删除会话时自动级联删除相关消息

## API 接口

创建了以下新的 API 接口:

### 会话管理
- `GET /api/chat-sessions` - 获取会话列表
- `POST /api/chat-sessions` - 创建新会话
- `DELETE /api/chat-sessions?id={id}` - 删除会话
- `PATCH /api/chat-sessions/{id}` - 更新会话标题

### 消息管理
- `GET /api/chat-sessions/{id}` - 获取会话消息
- `POST /api/chat-sessions/{id}/messages` - 保存消息

## 使用说明

### 查看历史对话
1. 点击顶部的"对话记录"按钮
2. 侧边栏会显示所有历史对话
3. 对话按更新时间倒序排列

### 创建新对话
1. 点击侧边栏顶部的"新建对话"按钮
2. 或者在没有当前会话时直接发送消息,会自动创建

### 继续历史对话
1. 在侧边栏中点击任意历史对话
2. 会自动加载该对话的所有消息
3. 可以继续在该对话中发送新消息

### 删除对话
1. 鼠标悬停在会话上,会显示删除按钮
2. 点击删除按钮并确认
3. 对话及其所有消息将被永久删除

## 自动功能

### 自动保存
- 每次发送消息后自动保存到数据库
- 包括用户消息和AI回复
- 保存深思模式等元数据

### 自动标题
- 新建对话时默认标题为"新对话"
- 发送第一条消息后,自动使用消息前20个字符作为标题
- 可以帮助快速识别对话内容

### 自动更新时间
- 每次在对话中发送消息,会更新对话的 `updated_at`
- 确保最新活跃的对话显示在列表顶部

## 移动端适配

- 侧边栏在移动端会以全屏抽屉形式展示
- 包含遮罩层,点击遮罩可关闭侧边栏
- 桌面端侧边栏保持固定显示

## 注意事项

1. **必须登录** - 聊天记录功能需要用户登录才能使用
2. **数据隔离** - 每个用户只能看到自己的对话记录
3. **自动保存** - 所有对话会自动保存,无需手动操作
4. **性能优化** - 会话列表按更新时间排序,最新的在前面

## 故障排除

### 无法保存消息
- 检查是否已执行数据库迁移脚本
- 确认用户已登录
- 查看浏览器控制台是否有错误信息

### 会话列表为空
- 确认已发送过消息(第一次使用需要先创建对话)
- 检查是否使用了正确的用户账号登录
- 刷新页面重新加载会话列表

### 无法加载历史消息
- 确认会话ID正确
- 检查网络连接
- 查看浏览器控制台的错误日志
